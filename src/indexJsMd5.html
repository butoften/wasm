<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script src="./SparkMD5.js"></script>
  <script src="./wasm_exec.js"></script>
  <!-- <script src="./wasm_exec_tiny.js"></script> -->
</head>

<body>
  <script>

  </script>
  <input id="file" type="file" />
  <script>
    document.querySelector('#file').addEventListener('change', e => {
      let startTime = Date.now()
      const file = e.target.files[0];
      const fileReader = new FileReader()
      console.log('size', file.size / 1024 / 1024 / 1024, "G")
      // console.log('type after change', file)

      fileReader.onprogress = e => {
        console.log(`${Math.floor((e.loaded / e.total) * 100)}%`)
      }
      let usedTime = 0
      const md5 = new SparkMD5();
      let index = 0
      const chunkSize = 512 * 1024 * 1024;//file.size / count
      let count = Math.ceil(file.size / chunkSize)
      console.log('分几份', count)

      loadSliceFile();
      function loadSliceFile() {
        const sliceFile = file.slice(index * chunkSize, index * chunkSize + chunkSize)
        fileReader.readAsBinaryString(sliceFile);
      }
      fileReader.onload = e => {
        index += 1;
        md5.appendBinary(e.target.result);
        if (index < count) {
          loadSliceFile()
        }
        else {
          const md5Str = md5.end()
          usedTime += Date.now() - startTime
          console.log('usedTime', usedTime, 'ms')
          console.log('md5', md5Str)
        }
      }
    });
    /* document.querySelector('#file').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      const buffer = await file.arrayBuffer();
      const bytes = new Uint8Array(buffer)
      console.log('开始给go')
      const md5v = getFileMd5(bytes)
      console.log(md5v)
      return;
      const fileReader = new FileReader()
      console.log('size', file.size / 1024 / 1024 / 1024, "G")
      console.log('type after change', file)

      fileReader.onprogress = e => {
        console.log(`${Math.floor((e.loaded / e.total) * 100)}%`)
      }
      let usedTime = 0
      let index = 0
      let count = 1
      const chunkSize = file.size / count
      loadSliceFile();
      function loadSliceFile() {
        fileReader.readAsArrayBuffer(file);
      }
      fileReader.onload = e => {
        const bytes = new Uint8Array(e.target.result)
        getFileMd5(bytes)
      }
    }); */
//分段 md5 4b26c974ebb21f5bdfe3ae04a8d322b3

//整体 d41d8cd98f00b204e9800998ecf8427e
//usedTime 18.048 秒
//md5 d41d8cd98f00b204e9800998ecf8427e

//wasm 22s

//22多MB文件
//js usedTime 0.069 秒 0.045 秒
//js firefox usedTime 0.007 秒  0.001 秒
//go usedTime: 0.212300032 秒  0.1968秒 0.210000128 秒
//1d669eeb45dfe2b224c883c77fbeaa11


  </script>
</body>

</html>
